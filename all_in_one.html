

<!DOCTYPE HTML>
<html>

<head>
  <script src = "https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.5.0/fabric.js"></script>
  <script src="http://rubaxa.github.io/Sortable/Sortable.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="dentist.js"></script>

  <style>
  #feedback { font-size: 1.4em; }
  #floor_list .ui-selected { background: #F39814; color: black; }
  #beacon_list .highlighted{
    background: #F39814; color: black;
  }
  #POI_list .highlighted{
    background: #F39814; color: black;
  }
  #data_list .highlighted{
    background: #F39814; color: black;

  }

  div.scroll {
    overflow: scroll;
  }
  .fill_bigger{
    height: 75vh;
    width: 100%;
    position:relative;
    box-sizing:border-box;
  }
  .fill_all{
    height: 85vh;
    width: 100%;
    position:relative;
    box-sizing:border-box;
  }
  .fill {
    height: 70vh;
    width: 100%;
    position:relative;
    box-sizing:border-box;
  }

  .vertical_center{
    display: inline-block;
    vertical-align: middle;
    float: none;
  }

  .canvas_container{
    width: 100%;
    max-width: 800px;
    height: auto;
    min-width:400px;
  }

  .min_width6{
    min-width:450px;
  }
  .min_width3{
    min-width:200px;
  }
  .min_width12{
    min-width:950px;
  }
  .list-group-item{
    background:#F12341;
  }

  </style>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
  <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.14.0/jquery.validate.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/json2/20150503/json2.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

</head>

<body>
<div id = "all" class =" container-fluid min_width12">
  <div class = "row-fluid">
    <div id = "floor_list_div" class=" panel panel-default col-xs-3 min_width3">
      <h2 class = "panel-heading text-center">
         Floor List
       </h2>
      <div class = "panel-body scroll fill_bigger well">
        <ul id = "floor_list" class = "floor_list list-group"></ul>
      </div>
      <div class = "panel-footer">
        <button id = "add_floor" class = "btn btn-primary" style="float:right;"> Add New Floor</button>
        <div class="clearfix"></div>
      </div>

    </div>

    <div id = "middle_panel" class=" col-xs-6 panel panel-default fill_all min_width6">
      <div id = "canvas_div" class = "panel-body " >
        <canvas id = "floor_map" class = " center-block" style = "border:1px solid"></canvas>
        <input id = "image" type = "file" accept = "image/*">
      </div>
      <div id = "toggle_div" class = " panel-footer text-center" display = "inline-block">
        <input type="radio" name="view" value="Edit lock" onchange="toggle_editlock();" id="edit_lock" checked>
        <label for="editlock_button" class="switch-label switch-label-on">Edit Lock</label>
        <input type="radio" name="view" value="Beacon Data" onchange="toggle_beacon();" id="beacon_button">
        <label for="beacon_button" class="switch-label switch-label-off">Beacon Data</label>
        <input type="radio" name="view" value="Training Data" onchange="toggle_tdata();" id="training_button">
        <label for="training_button" class="switch-label switch-label-on">Training Data</label>
        <input type="radio" name="view" value="Point of Interest" onchange="toggle_POI();" id="POI_button">
        <label for="POI_button" class="switch-label switch-label-on">Point of Interest</label>
      </div>
  </div>

<div class ="panel panel-default  col-xs-3 min_width3">
  <div class = "panel-group" id = "lists" style="height:80%; ">
    <div id = "beacon_list_div" class = "panel panel-default">
      <div class="panel-heading">
        <h2 class="panel-title text-center">
          <a data-toggle="collapse" data-parent="#lists" href="#collapseOne">
            Beacon Data List
          </a>
        </h2>
      </div>
      <div id="collapseOne" class="panel-collapse collapse in">
        <div class = "panel-body fill">
          <ul id = "beacon_list" class = "beacon_list list-group"></ul>
        </div>
      </div>
    </div>

    <div id = "training_data_div" class = "panel panel-default">
      <div class="panel-heading">
        <h2 class="panel-title text-center">
          <a data-toggle="collapse" data-parent="#lists" href="#collapseTwo">
            Training Data List
          </a>
        </h2>
      </div>
      <div id="collapseTwo" class="panel-collapse collapse">
        <div class = "panel-body fill">
          <ul id = "data_list" class = "data_list list-group"></ul>
        </div>
      </div>
    </div>

      <div id = "POI_list_div" class = "panel panel-default">
        <div class="panel-heading">
          <h2 class="panel-title text-center">
            <a data-toggle="collapse" data-parent="#lists" href="#collapseThree">
              Points of interests List
            </a>
          </h2>
        </div>
          <div id="collapseThree" class="panel-collapse collapse">
            <div class = "panel-body fill">
              <ul id = "POI_list" class = "POI_list list-group"></ul>
            </div>
          </div>
        </div>
      </div>
      <div class = "panel-footer">
        <button id = "confirm" onclick="$('#confirmation_dialog').modal('toggle')" class = "btn btn-success" style = "float:right;"> Confirm</button>
        <button id = "help" onclick ="help()" class = "btn btn-info" style = "float:right"> Help</button>
        <div class="clearfix"></div>
      </div>
    </div>
  </div>
</div>
  <div class = "modal fade" id = "floor_dialog" role="dialog">
    <div class = "modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Adding a new floor</h4>
        </div>
          <div class="modal-body" >
            <div class = "form-group">
            <form id = "floor_form">
              <label>Enter the name of the floor here</label>
              <input type = "text; button" id = "floor_name" name = "floor_name" />
          </div>
        </div>
            <div class = "modal-footer">
              <input type="button" class = "btn btn-default" data-dismiss="modal" onclick="clear_input('#floor_name')"value="Cancel"/>
              <input type = "submit" class = "btn btn-default" onclick="add_floor()" value = "Confirm"/>
            </div>
          </form>
      </div>
    </div>
  </div>

  <div class = "modal fade" id = "beacon_dialog">
    <div class = "modal-dialog modal-sm">
      <div class="modal-content" >
        <div class="modal-header">
          <h4 class="modal-title">Adding a new beacon</h4>
        </div>
        <div class = "form-group">
          <div class="modal-body">
            <form id = "beacon_form" method="get" action="">
              <label> Enter the name of the beacon: </label>
              <input type = "text" id = "beacon_name" name = "beacon_name" />
          </div>
        </div>
        <div class = "modal-footer">
          <input type = "button" class = "btn btn-default" data-dismiss="modal" onclick="clear_input('#beacon_name')" value = "Cancel"/>
          <input type = "submit" class = "btn btn-default" onclick="add_beacon()" value = "Confirm"/>
        </div>
      </form>
      </div>
    </div>
  </div>

  <div class = "modal fade"  id = "tdata_dialog">
    <div class = "modal-dialog modal-sm">
    <div class="modal-content" >
      <div class="modal-header">
        <h4 class="modal-title">Adding new training data</h4>
      </div>
      <div class="modal-body">
        <ul id = "enter_tdata_list" name = "enter_tdata_list" class = "enter_tdata_list list-group"></ul>
        <div class = "form-group">
          <form id = "tdata_form" method="get" action="">
            <label for"tdata_name"> Beacon detected: </label>
            <input type = "text" id = "tdata_name" name = "tdata_name" />
            <label for="rssi_value"> RSSI for that beacon: </label>
            <input type = "integer" id = "rssi_value" name = "rssi_value" />
        </div>
      </div>
            <div class = "modal-footer">
              <input type ="submit" class = "btn btn-default" onclick="add_tdata_list()" value = "Add"/>
              <input type ="button" class = "btn btn-default" data-dismiss="modal" onclick="clear_input('#rssi_value');clear_input('#tdata_name')"value="Cancel"/>
              <input type = "button" class = "btn btn-default" onclick="add_tdata()" value = "Confirm">
            </div>
          </form>
        </div>
      </div>
  </div>

<div class = "modal fade" id = "POI_dialog">
  <div class = "modal-dialog modal-sm">
    <div  class="modal-content" >
      <div class="modal-header">
        <h4 class="modal-title">Adding a new point of interest</h4>
      </div>
        <div class="modal-body">
          <div class = "form-group">
            <form id = "POI_form" method="get" action="" onsubmit="return false">
              <label> Enter the name of the point of interest </label>
              <input type = "text" id ="POI_name" name = "POI_name"/>
              <label> Select the type of interest </label>
              <select id = "POI_select" name = "POI_select">
                <option value = "Room"/>Room</option>
                <option value = "Stairs"/>Stairs</option>
                <option value = "Toilet"/>Toilet</option>
                <option value = "Dining"/>Dining</option>
                <option value = "Entrance/Exit"/> Entrance/Exit </option>
              </select>
          </div>
        </div>
            <div class = "modal-footer">
              <input type ="button" class = "btn btn-default" data-dismiss="modal" onclick="clear_input('#POI_name')" value = "Cancel"/>
              <input type = "submit" class = "btn btn-default" onclick ="add_POI()" value = "Confirm"/>
            </div>
          </form>
    </div>
  </div>
</div>

<div class = "modal fade" id = "confirmation_dialog">
  <div class = "modal-dialog modal-sm">
    <div class="modal-content" >
      <div class="modal-header">
        <h4 class="modal-title">Confirmation</h4>
      </div>
      <div class = "form-group">
        <div class="modal-body">
          <form id = "confirmation_form" method="get" action="">
            <label> Finally, please enter an image for the building itself</label>
            <input id = "building_image" type = "file" accept = "image/*">
        </div>
      </div>
      <div class = "modal-footer">
        <input type = "button" class = "btn btn-default" data-dismiss="modal" value = "Cancel"/>
        <input type = "button" class = "btn btn-default" onclick="send_data()" value = "Confirm"/>
      </div>
    </form>
    </div>
  </div>
</div>

  <script>
  "use strict"
  //global variables
  var floor_array = [];
  //booby fake init floor
  var current_floor = null;
  //used to control which variable is currently entering, 0 = editlocked, 1 = beacon, 2 = tdata 3 = point of interest
  var status = 0;

  var building_height;
  var building_width;
  //how many meter each box represents
  var grid_size = 0.5;
  var box_x;
  var box_y;
  var tdata_entry = {};
  var building_image;
  var url;
  var url_params;
  var cached_building;

jQuery(document).ready(function($) {
    $("#image").prop('disabled', 'true');
    url = document.URL;
    //= document.URL;
    url_params = url.extract();


    $("#add_floor").click(function(){
      $("#floor_dialog").modal('toggle');
    })
    $("#floor_dialog").modal('hide');
    $("#beacon_dialog").modal('hide');
    $("#tdata_dialog").modal('hide');
    $("#POI_dialog").modal('hide');
    $("#confirmation_dialog").modal('hide');

    cached_building = JSON.parse(window.App.Data.cached_building);
     console.log(window.App.Data.cached_building);
    if(Object.keys(cached_building).length!==0){
        console.log(cached_building);
        for(var i = 0; i < Object.keys(cached_building.floors).length; i++){
          floor_array.push(parse_floor(cached_building.floors[Object.keys(cached_building.floors)[i]]));
          floor_array[i].floor_map = new Image();
          floor_array[i].floor_map.src = 'data:image/png;base64,'+cached_building.images[i];
          $('<li class = "list-group-item"><span class="handle glyphicon glyphicon-menu-hamburger"></span>'
               +floor_array[i].name+ '<i class="js-remove badge">Remove</i>'+ '</li>').appendTo("ul.floor_list");
          console.log(floor_array);
        }
      building_image = new Image();
      building_image.src = 'data:image/png;base64,'+cached_building.building_image;
      building_height = cached_building.buildingHeight;
      building_width = cached_building.buildingWidth;
      box_x = cached_building.boxes_x;
      box_y = cached_building.boxes_y;
      if(floor_array.length != 0){
        $("#image").prop('disabled', false);
      }
    } else {
      building_height = url_params.building_height;
      building_width = url_params.building_width;
      box_x = building_width / grid_size;
      box_y  = building_height / grid_size;
    }

    var resizeTimeout;
    $(window).resize(function(){
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function(){
          var real_width = $("#floor_map").width();
          var supposed_size = get_canvas_size();
          if (real_width != supposed_size[0]){
            rescale_canvas(supposed_size);
          }
        }, 100);
    });

    var canvas_size = get_canvas_size();
    console.log(canvas_size);
    canvas.setHeight(canvas_size[1]);
    canvas.setWidth(canvas_size[0]);

    $("#floor_list").sortable({
      handle:".handle",
      start: function(event, ui) {
        ui.item.startPos = ui.item.index();
      },
      update: function(event, ui) {
        ui.item.endPos = ui.item.index();
        var removed = floor_array.splice(ui.item.startPos,1)[0];
        floor_array.splice(ui.item.endPos,0,removed);
      }

    }).selectable({
      filter: "li",
      cancel: ".handle",
      //prevents multiple selection
        selecting: function(event, ui){
            if( $(".ui-selected, .ui-selecting").length > 1){
                  $(ui.selecting).removeClass("ui-selecting");
            }
        },
        //upon selection, change the canvas to the selected floor
        selected: function(event, ui){
          console.log(ui);
          $( ".ui-selected", this ).each(function() {
            console.log($(".ui-selected"));
            var index = $( "#floor_list li" ).index( this );
            current_floor = floor_array[index];
            clear_floor();
            update_floor();
          });
        },

    });

    $("#beacon_list").on("click", "li.list-group-item",function() {
      var index = $(this).index();
      if($(this).hasClass("highlighted")){
        shrink_obj(find_canvas_obj(current_floor.beacons, index));
        $(this).removeClass("highlighted");
      } else {
        $(".highlighted").removeClass("highlighted");
        enlarge_obj(find_canvas_obj(current_floor.beacons, index));
        $(this).addClass("highlighted");
      }
    });

    $("#data_list").on("click", "li.list-group-item", function() {
      var index = $(this).index();
      if($(this).hasClass("highlighted")){
        shrink_obj(find_canvas_obj(current_floor.training_data, index));
        $(this).removeClass("highlighted");
      } else {
        $(".highlighted").removeClass("highlighted");
        enlarge_obj(find_canvas_obj(current_floor.training_data, index));
        $(this).addClass("highlighted");
      }

    });
    $("#POI_list").on("click", "li.list-group-item", function() {
        var index = $(this).index();
        if($(this).hasClass("highlighted")){
          shrink_obj(find_canvas_obj(current_floor.POI, index));
          $(this).removeClass("highlighted");
        } else {
          $(".highlighted").removeClass("highlighted");
          enlarge_obj(find_canvas_obj(current_floor.POI, index));
          $(this).addClass("highlighted");
        }
    });

    $("#floor_form").validate({
      rules: {
        floor_name:{
          required: true,
          minlength: 4,
        },
      },
      messages:{
        floor_name:{
          required: "please enter a name for this floor",
          minlength: "the minimum length of the name is 4",
        }
      }
    });
    $("#beacon_form").validate({
      rules: {
        beacon_name:{
          required: true,
          minlength: 4,
        },
      },
      messages:{
        beacon_name:{
          required: "please enter a name for the beacon",
          minlength: "the minimum length of the name is 4",
        }
      }
    });
    $("#tdata_form").validate({
      rules: {
        tdata_name:{
          required: true,
          minlength: 4,
        },
        rssi_value:{
          required:true
        }
      },
      messages:{
        tdata_name:{
          required: "please enter a name for this ",
          minlength: "the minimum length of the name is 4",
        },
        rssi_value:{
          required:"please enter the rssi value detected for this beacon",
        }

      }
    });
  });

    function parse_floor(floor_obj){
      console.log(floor_obj["POI"]);
      var floor = {
        name:floor_obj["name"],
        POI:parse_POI(floor_obj["POI"]),
        training_data:parse_tdata(floor_obj["training_data"]),
        beacons:parse_beacons(floor_obj["beacons"]),
        beacon_id:floor_obj["beacon_id"],
        tdata_id:floor_obj["tdata_id"],
        poi_id:floor_obj["poi_id"],
      }
      return floor;
    }

    function parse_beacons(obj){
      var array = [];
      Object.keys(obj).forEach(function(key){
        var beacon = {
          name:obj[key]["name"],
          id:obj[key]["id"],
          left:parseInt(obj[key]["left"]),
          top:parseInt(obj[key]["top"]),
        }
        array.push(beacon);
      })
      return array;
    }

    function parse_POI(obj){
      var array = [];
      Object.keys(obj).forEach(function(key){
        var poi = {
          name:obj[key]["name"],
          id:obj[key]["id"],
          left:parseInt(obj[key]["left"]),
          top:parseInt(obj[key]["top"]),
          type:obj[key]["type"],
        }
        array.push(poi);
      })
      return array;
    }

    function parse_tdata(obj){
      var array = [];
      for(var i = 0; i<Object.keys(obj).length; i++){
          var tdata = {
            id:obj[Object.keys(obj)[i]]["id"],
            left:parseInt(obj[Object.keys(obj)[i]]["left"]),
            top:parseInt(obj[Object.keys(obj)[i]]["top"]),
            data:parse_tdata_list(obj[Object.keys(obj)[i]]["data"]),
          }
          array.push(tdata);
      }
      return array;
    }

    function parse_tdata_list(list){
      var data = {};
      console.log(list);
      Object.keys(list).forEach(function(key){
        data[key] = list[key];
      })
      return data;
    }



  function shrink_obj(item){
    item.scaleX = 0.75;
    item.scaleY = 0.75;
    canvas.renderAll();
  }

  function find_canvas_obj(list, index){
    var i = findById(canvas.getObjects(),list[index].id);
    return canvas.item(i);
  }

  function enlarge_obj(item){
    if(canvas.getActiveObject()!= null){
      shrink_obj(canvas.getActiveObject());
    }
    item.scaleX = 4/3;
    item.scaleY = 4/3;
    canvas.setActiveObject(item);
    canvas.renderAll();
  }


  //canvas scripts
  var canvas = new fabric.Canvas("floor_map");
  canvas.selection = true;
  canvas.addOnAddRemove = true;
  function add_grid_lines(x_len, y_len){
    //add vertical lines
    for (var i = 0; i < box_x; i++) {
      canvas.add(new fabric.Line([ i * (x_len/box_x), 0, i * (x_len/box_x), y_len], { stroke: '#ccc', selectable: false }));

    }
    //add horizontal lines
    for(var i = 0; i < box_y; i++){
      canvas.add(new fabric.Line([ 0, i * y_len/box_y, x_len, i * y_len/box_y], { stroke: '#ccc', selectable: false }));
    }
  }

  function reset_floor(){
    current_floor.beacons = [];
    current_floor.training_data = [];
    current_floor.POI=[];
    current_floor.beacon_id = 0;
    current_floor.poi_id = 0;
    current_floor.floor_id = 0;
    current_floor.floor_map = null;
    clear_floor();
  }

  function clear_input(id){
    $(id).val('');
  }

  function add_beacon(){
    if($("#beacon_form").valid()){
      var x = $("#beacon_dialog").data("x");
      var y = $("#beacon_dialog").data("y");
      var name = $("#beacon_name").val();
      $("#beacon_name").val("");
      if(unique_beacon_name(name)){
        var id = 'bc' + current_floor.beacon_id++;
        var symbol = new fabric.Circle({radius:5, fill:'green',top:grid_to_pixel_y(y), originX:"center", originY:"center", left:grid_to_pixel_x(x), id:id});
        canvas.add(symbol);
        lock_symbol(symbol);
        canvas.renderAll();
        var beacon = {name:name, top:y, left:x, id:id};
        $("<li class='list-group-item'>"+beacon.name+ '<i class="beacon-remove badge">Remove</i>'+ "</li>").appendTo("ul.beacon_list");
        current_floor.beacons.push(beacon);
        $("#beacon_dialog").modal('toggle');
      }else{
        alert("beacon name entered already exists!");
     }
   }
  }

 function add_tdata_list(){
   if($("#tdata_form").valid()){
     tdata_entry[$("#tdata_name").val()] = $("#rssi_value").val();
     $("<li class='list-group-item'>"+$("#tdata_name").val() +": " + $("#rssi_value").val() + '<i class="enter_tdata_remove badge">Remove</i>'+ "</li>").appendTo("ul.enter_tdata_list");
     $("#tdata_name").val("");
     $("#rssi_value").val('');
   }
 }

 function add_tdata(){
   if(Object.keys(tdata_entry).length==0){
     alert("there is no data to enter!");
   } else {
     var x = $("#tdata_dialog").data("x");
     var y = $("#tdata_dialog").data("y");
     var id = 'td' + current_floor.tdata_id++;
     var symbol = new fabric.Triangle({width:10, height:10, fill:'blue', top:grid_to_pixel_y(y), originX:"center", originY:"center",left:grid_to_pixel_x(x), id:id});
     canvas.add(symbol);
     lock_symbol(symbol);
     canvas.renderAll();
     var tdata = {top:y, left:x, id:id, data:tdata_entry};
     $("<li class='list-group-item'>(X:"+x+", Y:"+y+")" + '<i class="data-remove badge">Remove</i>'+ "</li>").appendTo("ul.data_list");
     current_floor.training_data.push(tdata);
     tdata_entry = {};
     $("#enter_tdata_list").empty();
     $("#tdata_dialog").modal('toggle');
   }
 }
 function add_POI(){
   console.log("got here");
   if($("#POI_form").valid()){
     var x = $("#POI_dialog").data("x");
     var y = $("#POI_dialog").data("y");
     var id = 'poi' + current_floor.poi_id++;
     var name = $("#POI_name").val();
     $("#POI_name").val("");
     var type = $("#POI_select").val();
     var symbol = new fabric.Rect({height:10, width:10, type:type, fill:'red',top:grid_to_pixel_y(y),originX:"center", originY:"center", left:grid_to_pixel_x(x), id:id});
     canvas.add(symbol);
     lock_symbol(symbol);
     canvas.renderAll();
     var PoI = {name:name, top:y, left:x, id:id, type:type};
     $("<li class='list-group-item'>"+PoI.name+'<i class="poi-remove badge">Remove</i>'+ "</li>").appendTo("ul.POI_list");
     current_floor.POI.push(PoI);
     $("#POI_dialog").modal('toggle');
     console.log(current_floor.POI);
   }
 }

  canvas.on('mouse:down', function(options){
    var symbol = null;
    if (options.target){
    }else{
      var pointer = canvas.getPointer(options.e);
      var x = pixel_to_grid_x(Math.round(pointer.x));
      var y = pixel_to_grid_y(Math.round(pointer.y));
      switch (+status) {
        case 0:break;
        case 1:
          $("#beacon_dialog").data("x",x);
          $("#beacon_dialog").data("y",y);
          $("#beacon_dialog").modal('toggle');
          break;
        case 2:
          $("#tdata_dialog").data("x",x);
          $("#tdata_dialog").data("y",y);
          $("#tdata_dialog").modal('toggle');
            break;
        case 3:
          $("#POI_dialog").data("x",x);
          $("#POI_dialog").data("y",y);
          $("#POI_dialog").modal('toggle');
          break;
        default:
          break;
      }
    }
  })


function unique_beacon_name(name){
  for(var i = 0; i < floor_array.length; i++){
    for (var j = 0 ; j < floor_array[i].beacons.length; j++){
      if(floor_array[i].beacons[j].name === name) return false;
    }
  }
  return true;
}

function unique_floor_name(name){
  for(var i = 0; i < floor_array.length; i++){
    if(floor_array[i].name === name) return false;
  }
  return true;
}

//called when a new floor is selected
  function update_floor(){
    //if there isnt a map then there's no data
    if(current_floor.floor_map != null){
      var new_background = new fabric.Image(current_floor.floor_map);
      scale_image(new_background, canvas.width);
      canvas.setHeight(new_background.height);
      canvas.setWidth(new_background.width);
      add_grid_lines(new_background.width, new_background.height);
      canvas.setBackgroundImage(new_background, canvas.renderAll.bind(canvas));
      for(var i = 0; i < current_floor.beacons.length; i++){
        var beacon = current_floor.beacons[i];
        var symbol = new fabric.Circle({radius:5, fill:'green',top:grid_to_pixel_y(beacon.top), originX:"center", originY:"center",left:grid_to_pixel_x(beacon.left), id:beacon.id});
        canvas.add(symbol);
        lock_symbol(symbol);
        $("<li class='list-group-item'>"+beacon.name+ '<i class="beacon-remove badge">Remove</i>'+ "</li>").appendTo("ul.beacon_list");
      }
      for(var i = 0; i < current_floor.training_data.length; i++){
        var tdata = current_floor.training_data[i];
        var symbol = new fabric.Triangle({width:10,height:10, fill:'blue',top:grid_to_pixel_y(tdata.top), originX:"center", originY:"center",left:grid_to_pixel_x(tdata.left), id:tdata.id});
        canvas.add(symbol);
        lock_symbol(symbol);
        $("<li class='list-group-item'>(X:"+tdata.top+", Y:"+tdata.left+")" + '<i class="data-remove badge">Remove</i>'+ "</li>").appendTo("ul.data_list");
      }
      for(var i = 0; i< current_floor.POI.length;i++){
        var poi = current_floor.POI[i];
        var symbol = new fabric.Rect({width:10, height:10, fill:"red", top:grid_to_pixel_y(poi.top),originX:"center", originY:"center", left:grid_to_pixel_x(poi.left), id:poi.id});
        lock_symbol(symbol);
        canvas.add(symbol);
        $("<li class='list-group-item'>"+poi.name+'<i class="poi-remove badge">Remove</i>'+ "</li>").appendTo("ul.POI_list");
      }
      canvas.renderAll();
    }
    status = 0;
    $("#edit_lock").prop("checked", true);
  }

  function lock_symbol(symbol){
    symbol.lockMovementY = true;
    symbol.lockMovementX = true;
    symbol.hasControls = false;
  }

  document.getElementById("image").onchange = function handleImage(e){
    //if(current_floor.backgroundImage != null//||confirm("By uploading a new floor map, all current data placed for this floor will be removed, would you like to continue?")
     // ){

      //  reset_floor();
        canvas.backgroundImage = null;
    canvas.clear().renderAll;
    var reader = new FileReader();
    reader.onload = function (event){
      var imgObj = new Image();
      imgObj.src = event.target.result;
      imgObj.onload = function() {
        var image = new fabric.Image(imgObj);
        scale_image(image,canvas.width);
        canvas.setHeight(image.height);
        canvas.setWidth(image.width);
        add_grid_lines(image.width, image.height);
        canvas.setBackgroundImage(image, canvas.renderAll.bind(canvas));
        //could ask to remove stuff here
        current_floor.floor_map = imgObj;
        repopulate_canvas_objects();
      }
    }
    reader.readAsDataURL(e.target.files[0]);
  //}
  };

  document.getElementById("building_image").onchange = function handleImage(e){
    var reader = new FileReader();
    reader.onload = function(event){
      building_image = new Image();
      building_image.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
  }

//input is a fabric js image
function scale_image(image, width){
  image.set({
    angle:0,
    padding:10,
    cornersize:10,
    height:(building_height/building_width).toFixed(1)*width,
    width:width
  })
}

function rescale_canvas(size){
  if(has_background_image()){
    console.log("rescaled!");
    var new_background_img = canvas.backgroundImage;
    scale_image(new_background_img,size[0]);
    canvas.backgroundImage = null;
    canvas.clear().renderAll;
    canvas.setWidth(new_background_img.width);
    canvas.setHeight(new_background_img.height);
    canvas.setBackgroundImage(new_background_img);
    repopulate_canvas_objects();
  } else {
    canvas.setWidth(size[0]);
    canvas.setHeight(size[1]);
  }
}

function repopulate_canvas_objects(){
      for(var i = 0; i < current_floor.beacons.length; i++){
      var beacon = current_floor.beacons[i];
      var symbol = new fabric.Circle({radius:5, fill:'green', originX:"center", originY:"center",top:grid_to_pixel_y(beacon.top), left:grid_to_pixel_x(beacon.left), id:beacon.id});
      canvas.add(symbol);
      lock_symbol(symbol);
    }
    for(var i = 0; i < current_floor.training_data.length; i++){
      var tdata = current_floor.training_data[i];
      var symbol = new fabric.Triangle({width:10,height:10, fill:'blue', originX:"center", originY:"center",top:grid_to_pixel_y(tdata.top), left:grid_to_pixel_x(tdata.left), id:tdata.id});
      canvas.add(symbol);
      lock_symbol(symbol);
    }
    for(var i = 0; i< current_floor.POI.length;i++){
      var poi = current_floor.POI[i];
      var symbol = new fabric.Rect({width:10, height:10,originX:"center", originY:"center", fill:"red", top:grid_to_pixel_y(poi.top), left:grid_to_pixel_x(poi.left), id:poi.id});
      lock_symbol(symbol);
      canvas.add(symbol);
    }
    add_grid_lines(canvas.width, canvas.height);
    canvas.renderAll();
}

function get_canvas_size(){
  var canvas_container_width = $("#middle_panel").width();
  console.log(canvas_container_width);
  if(canvas_container_width > 1200) return [1200,800];
  else if (canvas_container_width > 800) return[800,600];
  else if (canvas_container_width >650) return [650,500];
  else if (canvas_container_width > 500) return[500,400];
  else return [400,300];
}

function pixel_to_grid_x(x){
  return Math.floor(x/(canvas.width/box_x));
}
function pixel_to_grid_y(y){
  return Math.floor(y/(canvas.height/box_y));
}
function grid_to_pixel_x(x){
  return Math.round((x+0.5)*(canvas.width/box_x).toFixed(2));
}
function grid_to_pixel_y(y){
  return Math.round((y+0.5)*(canvas.height/box_y).toFixed(2));
}
  //floor list script

  var floor_list = Sortable.create(document.getElementById("floor_list"),{
    sort : false,
    filter: '.js-remove',
    onFilter: function (evt) {
    var c = confirm("are you sure you wish to remove this floor");
    if(c){
      var el = floor_list.closest(evt.item); // get dragged item
      el && el.parentNode.removeChild(el);
      floor_array.splice(evt.oldIndex, 1);
      if(floor_array.length == 0){
         $("#image").prop('disabled', true);
       }else{
         var str_index = "#floor_list li:eq(" + (floor_array.length-1) + ")";
         $(str_index).addClass("ui-selected");
       }
      clear_floor();
    }}
  });

//removes objects on the canvas and lists
  function clear_floor(){
    canvas.backgroundImage = null;
    canvas.clear().renderAll;
    $("#beacon_list").empty();
    $("#data_list").empty();
    $("#POI_list").empty();
  }

  function add_floor(){
    {
      if($("#floor_form").valid()){
      var floor_name = $("#floor_name").val();
      $("#floor_name").val("");
      if(unique_floor_name(floor_name)){
        $('<li class = "list-group-item"><span class="handle glyphicon glyphicon-menu-hamburger"></span>    '
             +floor_name+ '<i class="js-remove badge">Remove</i>'+ '</li>').appendTo("ul.floor_list");
        var floor_object = {
          name:floor_name,
          beacons:[],
          training_data:[],
          POI:[],
          floor_map:null,
          beacon_id:0,
          tdata_id:0,
          poi_id:0,
        };
        current_floor = floor_object;
        floor_array.push(floor_object);
        $("#image").prop('disabled', false);
    //     $("#floor_list").find('li').removeClass("ui-selected");
     //   var str_index = "#floor_list li:eq(" + (floor_array.length-1) + ")";
       // $(str_index).addClass("ui-selected");
        $("#floor_dialog").modal('hide');
    } else {
     alert("floor name entered already exists!");
    }}
    }
  }
  //toggle scripts
  function toggle_editlock(){
    status = 0;
  }

  function toggle_beacon(){
    if(current_floor != null){
    if(has_background_image()){
      status = 1;
    } else {
      alert("Please upload a floor map first before adding data");
      $("#edit_lock").prop("checked", true);
    }} else {
      alert("Please enter a floor first before carry out any operations");
      $("#edit_lock").prop("checked", true);

    }
  }
  function toggle_tdata(){
    if(current_floor != null){
    if(has_background_image()){
      status = 2;
    } else {
      alert("Please upload a floor map first before adding data");
      $("#edit_lock").prop("checked", true);
    }} else {
      alert("Please enter a floor first before carry out any operations");
      $("#edit_lock").prop("checked", true);
    }
  }
  function toggle_POI(){
    if(current_floor != null){
    if(has_background_image()){
      status = 3;
    } else {
      alert("Please upload a floor map first before adding data");
      $("#edit_lock").prop("checked", true);
    }} else {
      alert("Please enter a floor first before carry out any operations");
      $("#edit_lock").prop("checked", true);

    }
  }

  //checks if the background is empty
  function has_background_image(){
    return canvas.backgroundImage != null;
  }


//used to find the object on the canvas that is currently selected
  function findById(array, id){
    for(var i = 0; i < array.length; i++){
      if(array[i].id === id){
        //array used guaranteed to have only one instance of the id, therefore returning
        //the first instance is enough
        return i;
      }
    }
    return -1;
  }
  //beacon data
  var beacon_list = Sortable.create(document.getElementById("beacon_list"),{
    filter: '.beacon-remove',
    sort: false,
    onFilter: function (evt) {
      var c = confirm("do you want to remove this beacon?");
      if(c){
        var el = beacon_list.closest(evt.item); // get dragged item
        el && el.parentNode.removeChild(el);
        //removes from the canvas
        var id = current_floor.beacons[evt.oldIndex].id;
        var index_on_canvas = findById(canvas.getObjects(), id);
        canvas.remove(canvas.item(index_on_canvas));
        //removes from the array
        current_floor.beacons.splice(evt.oldIndex, 1);
        $('#beacon_list.ui-selected').removeClass('ui-selected');
    } }
  });

  var enter_tdata_list = Sortable.create(document.getElementById("enter_tdata_list"),{
    filter:'.enter_tdata_remove',
    sort: false,
    onFilter:function(evt){
      var beacon = $("#enter_tdata_list li")[evt.oldIndex].innerHTML.split(':')[0];
      delete tdata_entry[beacon];
      var el = enter_tdata_list.closest(evt.item);
      el && el.parentNode.removeChild(el);
    }
  })

  //training data
  var data_list = Sortable.create(document.getElementById("data_list"),{
    filter: '.data-remove',
    sort:false,
    onFilter: function (evt) {
      var c = confirm("do you want to remove this data?");
      if(c){
        var el = data_list.closest(evt.item); // get dragged item
        el && el.parentNode.removeChild(el);
        //removes from the canvas
        var id = current_floor.training_data[evt.oldIndex].id;
        var index_on_canvas = findById(canvas.getObjects(), id);
        canvas.remove(canvas.item(index_on_canvas));
        //removes from the array
        current_floor.training_data.splice(evt.oldIndex, 1);
        $('#data_list.ui-selected').removeClass('ui-selected');
    } }
  });

  //poi data
  var POI_list = Sortable.create(document.getElementById("POI_list"),{
    filter: '.poi-remove',
    sort:false,
    onFilter: function (evt) {
      var c = confirm("do you want to remove this POI?");
      if(c){
        var el = POI_list.closest(evt.item); // get dragged item
        el && el.parentNode.removeChild(el);
        //removes from the canvas
        var id = current_floor.POI[evt.oldIndex].id;
        var index_on_canvas = findById(canvas.getObjects(), id);
        canvas.remove(canvas.item(index_on_canvas));
        //removes from the array
        current_floor.POI.splice(evt.oldIndex, 1);
        $('#POI_list.ui-selected').removeClass('ui-selected');
    } }
  });



  function send_data(){
      if(building_image != null){
      var image_array = [];
      for(var i = 0; i<floor_array.length; i++){
        image_array.push(getBase64Image(floor_array[i].floor_map));
      }

      $.ajax({
        url: '/save_config',
        type: 'POST',
        data: {
          data: {buildingName: url_params.building_name,
          namespace: url_params.namespace,
          buildingHeight: building_height,
          buildingWidth: building_width,
          addressLine: url_params.address_line,
          postcode: url_params.postcode,
          city: url_params.city,
          boxes_x: box_x,
          boxes_y: box_y,
          floors: _.map(floor_array, function(floor){
            return {name: floor.name,
             beacons: floor.beacons,
             training_data: floor.training_data,
             POI: floor.POI,
             beacon_id: floor.beacon_id,
             tdata_id: floor.tdata_id,
             poi_id: floor.poi_id}
          }),
          images: image_array,
          building_image:getBase64Image(building_image),

        },}
      });
      $("#confirmation_dialog").modal('toggle');
    } else {
      alert("Please upload an image for your building");
    }
  }
  function getBase64Image(img) {
      // Create an empty canvas element
      var canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;

      // Copy the image contents to the canvas
      var ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);

      // Get the data-URL formatted image
      // Firefox supports PNG and JPEG. You could check img.src to
      // guess the original format, but be aware the using "image/jpg"
      // will re-encode the image.
      var dataURL = canvas.toDataURL("image/png");

      return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
  }
  </script>
</body>

</html>
